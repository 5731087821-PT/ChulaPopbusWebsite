var PopbusTracker=function(){"use strict";function e(e){null!==a&&(""!==e?$(a).html(e).show():$(a).hide())}function t(t,n){void 0!==n&&null!==n&&(t+='<br><div style="font-size:0.8em;">Error message: ['+n.code+"] "+n.message+"</div>"),console.error(t),e(t)}function n(e){var t=v.getBusLineList();$(e).empty();for(var n=0;n<t.length;n++)$(e).append(t[n].getVisibleButtonObj())}function i(e){return new google.maps.Map(e,{center:{lat:13.739036,lng:100.529875},zoom:16,disableDefaultUI:!0})}Date.now||(Date.now=function(){return(new Date).getTime()});var o={},a=null,r=function(){function e(){o.resolve("Bus marker prototype image loaded"),i=!0}var t={},n=new Image;n.onload=e;var i=!1,o=new Parse.Promise,a={};return t.getColorizedIcon=function(e){if(!i)return null;if(!a.hasOwnProperty(e)){var t=parseInt(e.substr(0,2),16),o=parseInt(e.substr(2,2),16),r=parseInt(e.substr(4,2),16),s=document.createElement("canvas"),l=s.getContext("2d"),u=n.width,c=n.height;s.width=u,s.height=c,l.drawImage(n,0,0);for(var g=l.getImageData(0,0,u,c),f=g.data,d=0,h=f.length;h>d;d+=4){var v=f[d]/255;f[d+0]=Math.round(255*v+(1-v)*t),f[d+1]=Math.round(255*v+(1-v)*o),f[d+2]=Math.round(255*v+(1-v)*r)}l.putImageData(g,0,0),a[e]={url:s.toDataURL(),anchor:new google.maps.Point(20,20),scaledSize:new google.maps.Size(40,40)}}return a[e]},t.initialize=function(){n.src="./images/cu-popbus-map-full/bus_icons_general.png"},t.waitForImageLoad=function(){return o},t}(),s={NEW:1,OLD:2,SIGNAL_LOST:3},l=function(e,t){function n(){for(var t=v.getBusLineList(),n=0;n<t.length;n++)if(t[n].getLineNo()===e.getLineNo())return o=t[n],o.addBusNowMarker(i),a=t[n].getColor(),void(l=t[n].isVisible())}var i=this;this.setVisible=function(e){u.setVisible(e)};var o=null,a="666666",l=!0;n();var u=new google.maps.Marker({position:e.getLocation(),map:t,icon:r.getColorizedIcon(a),visible:l,clickable:!1});this.setBusOldLevel=function(e){switch(e){case s.NEW:u.setOpacity(1);break;case s.OLD:u.setOpacity(.5);break;case s.SIGNAL_LOST:u.setOpacity(.02)}},this.setBusOldLevel(e.getBusOldLevel()),this.destroy=function(){u.setMap(null),null!==o&&o.removeBusNowMarker(this)};var c=null,g=0,f=Date.now();this.animateTo=function(e){c=e,g=3e3,f=Date.now()},this.updateAnimation=function(){if(g>0){var e=Date.now()-f;if(e>=g)g=0,u.setPosition(c);else{var t=e/g,n=u.getPosition();u.setPosition({lat:t*c.lat+(1-t)*n.lat(),lng:t*c.lng+(1-t)*n.lng()}),g-=e}f=Date.now()}}},u=function(e){function t(e){n=e.IMEI,i=e.Name,o=String(e.LineNo),a=NaN;var t=e.GPSDateTime;if(null!==t&&void 0!==t){var s=t.indexOf(" "),l=t.substring(0,s),g=t.substring(s+1,t.length);a=Date.parse(l+"T"+g+"+07:00")}var f=e.LatLng,d=f.indexOf(",");r={lat:Number(f.substring(1,d)),lng:Number(f.substring(d+1,f.length-1))},u=e.Direction,c=e.Speed}var n,i,o,a,r,u,c,g=e;t(e);var f,d=null;this.createMarker=function(e){f=e,d=new l(this,e)},this.refreshMarker=function(e){void 0===e&&(e=this),d.destroy(),d=new l(e,f)},this.destroy=function(){console.log('Bus "'+i+'" ('+n+") is disappeared."),null!==d&&(d.destroy(),d=null)},this.update=function(e){if(!(isNaN(e.getDateTime())||!isNaN(this.getDateTime())&&this.getDateTime()>e.getDateTime())){if(null!==d)if(e.getLineNo()!==this.getLineNo())console.log("Change line from "+this.getLineNo()+" to "+e.getLineNo()),this.refreshMarker(e);else{var n=this.getLocation(),i=e.getLocation();(n.lat!==i.lat||n.lng!==i.lng)&&d.animateTo(i)}t(e.getOriginalJsonObj())}},this.getImei=function(){return n},this.getLocation=function(){return r},this.getLineNo=function(){return o},this.getDateTime=function(){return a},this.getOriginalJsonObj=function(){return g};var h=s.NEW;this.setBusOldLevel=function(e){h=e,null!==d&&d.setBusOldLevel(e)},this.getBusOldLevel=function(){return h},this.getName=function(){return i},this.updateAnimation=function(){null!==d&&d.updateAnimation()}},c=function(){function e(){var e,t=0;for(e=0;e<a.length;e++){var n=a[e].getDateTime();!isNaN(n)&&n>t&&(t=n)}var i=t-9e4,o=t-36e5;for(e=0;e<a.length;e++){var r=a[e].getDateTime();isNaN(r)||o>r?a[e].setBusOldLevel(s.SIGNAL_LOST):i>r?a[e].setBusOldLevel(s.OLD):a[e].setBusOldLevel(s.NEW)}}function t(){requestAnimationFrame(t);for(var e=0;e<a.length;e++)a[e].updateAnimation()}function n(){t()}var i,o={},a=[],r=!1;return o.linkMap=function(e){i=e},o.update=function(t){var o,s=a;a=[];var l={};for(o=0;o<s.length;o++)l[s[o].getImei()]=s[o];for(o=0;o<t.length;o++)if(l.hasOwnProperty(t[o].getImei())){var u=l[t[o].getImei()];u.update(t[o]),a.push(u),delete l[t[o].getImei()]}else t[o].createMarker(i),a.push(t[o]);for(o=0;o<s.length;o++)l.hasOwnProperty(s[o].getImei())&&s[o].destroy();e(),r||(r=!0,n())},o}(),g=function(){function n(e){for(var t=[],n=0;n<e.length;n++)"(0,0)"!==e[n].LatLng&&t.push(new u(e[n]));console.log("BusNow data fetched"),c.update(t)}function i(){setTimeout(o,5e3)}function o(){Parse.Cloud.run("getBusNow").then(function(o){var a=[];try{a=JSON.parse(o),e("")}catch(r){t("Server Anomaly: "+r.message)}n(a),i()},function(e){t("Server Anomaly",e),i()})}var a={};return a.startFetchCycle=function(){o()},a}(),f=function(){function e(e,n){null!==i&&(i.close(),i=null),i=new google.maps.InfoWindow({content:e}),i.open(t,n),i.addListener("closeclick",function(){i=null})}var t,n={},i=null;return n.linkMap=function(e){t=e},n.showStationInfoWindow=function(t){e(t.getInfoWindowContent(),t.getStationMarker())},n}(),d=function(e){var t=this,n=e.get("nameEn"),i=(e.get("nameTh"),{lat:e.get("location").latitude,lng:e.get("location").longitude}),o=e.id,a={path:google.maps.SymbolPath.CIRCLE,fillColor:"#FFFFFF",fillOpacity:1,anchor:new google.maps.Point(0,0),strokeWeight:1.5,scale:3.4},r=new google.maps.Marker({position:i,icon:a,title:n,visible:!1}),s=[],l=0;this.addLine=function(e){s.push(e),e.isVisible()&&this.increaseVisibleCounter()},this.linkMap=function(e){r.setMap(e),r.addListener("click",function(){f.showStationInfoWindow(t)})},this.decreaseVisibleCounter=function(){l--,0===l&&r.setVisible(!1)},this.increaseVisibleCounter=function(){l++,1===l&&r.setVisible(!0)},this.getStationMarker=function(){return r},this.getObjectId=function(){return o};var u=null;this.getInfoWindowContent=function(){if(null===u){for(var e="",t=v.getBusLineList(),i=0;i<t.length;i++){for(var o=!1,a=0;a<s.length;a++)if(s[a]===t[i]){o=!0;break}var r="#"+t[i].getColor();e+='<div class="bus-no" style="border: 1px solid '+(o?r:"rgba(0,0,0,0.60)")+";"+(o?"background: "+r+";":"")+'"></div>'}u='<div class="info_content"><div>'+n+'</div><div style="padding-top: 5px;">'+e+"</div></div>"}return u}},h=function(e){for(var t=this,n=!0,i=e.get("color"),o=e.get("name"),a=e.get("lineNo"),r=[],s=e.get("linePlan").get("pathway"),l=0;l<s.length;l++)r[l]={lat:s[l][0],lng:s[l][1]};var u=[],c=e.get("linePlan").get("stations");this.addStation=function(e){u.push(e)},this.getColor=function(){return i};var g=new google.maps.Polyline({path:r,geodesic:!0,strokeColor:"#"+i,strokeOpacity:1,strokeWeight:3,clickable:!1});this.linkMap=function(e){g.setMap(e)},this.isVisible=function(){return n},this.setVisible=function(e){if(e!==n){n=e,g.setVisible(n);for(var t=0;t<u.length;t++)n?u[t].increaseVisibleCounter():u[t].decreaseVisibleCounter()}},this.getStationIdInLineList=function(){return c};var f=null;this.onVisibleButtonClick=function(){this.setVisible(!this.isVisible()),this.isVisible()?TweenMax.to(f,.2,{color:"#FFF",backgroundColor:"#"+i,ease:Quad.easeOut}):TweenMax.to(f,.2,{color:"#"+i,backgroundColor:"rgba(255, 255, 255, 0.0)",ease:Quad.easeOut});for(var e=0;e<d.length;e++)d[e].setVisible(this.isVisible())},this.getVisibleButtonObj=function(){return null===f&&(f=$('<div class="rt pointer" style="border: 2px solid #'+i+"; color: #fff; background: #"+i+'"><strong>'+o+"</strong></div>"),f.click(function(){t.onVisibleButtonClick()})),f},this.getLineNo=function(){return a};var d=[];this.addBusNowMarker=function(e){d.push(e)},this.removeBusNowMarker=function(e){for(var t=d.length-1;t>=0;t--)d[t]===e&&d.splice(t,1)}},v=function(){function i(){var e=Parse.Object.extend("PopbusLines"),t=new Parse.Query(e);return t.equalTo("isShowInApp",!0),t.equalTo("isHidden",!1),t.include("linePlan"),t.ascending("name"),t.find()}function o(e){for(var t=[],n={},i=0;i<e.length;i++)for(var o=e[i].get("linePlan").get("stations"),a=0;a<o.length;a++){var r=o[a];n[r]!==!0&&(n[r]=!0,t.push(r))}return t}function a(e){var t=o(e),n=Parse.Object.extend("PopbusStations"),i=new Parse.Query(n);return i.containedIn("objectId",t),i.find()}function s(){var e,t,n={};for(e=0;e<c.length;e++)n[c[e].getObjectId()]=c[e];for(e=0;e<u.length;e++){var i=u[e].getStationIdInLineList();for(t=0;t<i.length;t++)n[i[t]].addLine(u[e]),u[e].addStation(n[i[t]])}}var l={},u=[],c=[];return l.getBusLineList=function(){return u},l.initializeData=function(o,l){i().then(function(e){for(var t=0;t<e.length;t++)u[t]=new h(e[t]),u[t].linkMap(o);return a(e)}).then(function(t){for(var i=0;i<t.length;i++)c[i]=new d(t[i]),c[i].linkMap(o);return s(),console.log("Data loading complete."),e("Loading Data..."),void 0!==l.lineButtonsDOM&&null!==l.lineButtonsDOM&&n(l.lineButtonsDOM),r.waitForImageLoad()},function(e){t("Loading Data Fail.",e)}).then(function(e){console.log(e),g.startFetchCycle()})},l}();return o.create=function(t){a=t.messageDOM,e("Loading Data..."),Parse.initialize("OS97kGW9YxCRuZYxb5uPeCbSmBAToHTOEY7JZn18","JNYrGMF92XJxleOQrKGx2UAc1feIAmKKYS4pYDDv");var n=i(t.mapDOM);r.initialize(),c.linkMap(n),f.linkMap(n),v.initializeData(n,t)},o}();$(document).ready(function(){PopbusTracker.create({mapDOM:$("#map-canvas")[0],lineButtonsDOM:$("#bus_line_visible_btn_group")[0],messageDOM:$("#error_msg")[0]})});